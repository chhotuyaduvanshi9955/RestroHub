<%layout("/layouts/boilerplate") %>

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    .location-search-page {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
        padding: 40px 20px;
    }

    .search-container {
        max-width: 1200px;
        margin: 0 auto;
    }

    /* Location Finder Section */
    .location-finder {
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        margin-bottom: 40px;
    }

    .finder-header {
        text-align: center;
        margin-bottom: 30px;
    }

    .finder-header h1 {
        font-size: 2.5rem;
        font-weight: 800;
        color: #333;
        margin-bottom: 10px;
    }

    .finder-header p {
        font-size: 1.1rem;
        color: #666;
        margin-bottom: 20px;
    }

    .location-methods {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .method-card {
        background: #f9f9f9;
        border: 2px solid #e0e0e0;
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .method-card:hover {
        border-color: #667eea;
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
        transform: translateY(-5px);
    }

    .method-card i {
        font-size: 2.5rem;
        color: #667eea;
        margin-bottom: 15px;
        display: block;
    }

    .method-card h3 {
        font-size: 1.2rem;
        font-weight: 700;
        color: #333;
        margin-bottom: 8px;
    }

    .method-card p {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 15px;
    }

    .method-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .method-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    /* Search Form Section */
    .search-form-section {
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        margin-bottom: 40px;
    }

    .form-title {
        font-size: 1.8rem;
        font-weight: 800;
        color: #333;
        margin-bottom: 30px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .search-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-group label {
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
    }

    .form-group input,
    .form-group select {
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .location-input {
        position: relative;
    }

    .location-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 2px solid #ddd;
        border-top: none;
        border-radius: 0 0 8px 8px;
        max-height: 200px;
        overflow-y: auto;
        display: none;
        z-index: 10;
    }

    .location-suggestions.active {
        display: block;
    }

    .suggestion-item {
        padding: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        border-bottom: 1px solid #eee;
    }

    .suggestion-item:hover {
        background: #f5f5f5;
        padding-left: 16px;
    }

    .suggestion-item:last-child {
        border-bottom: none;
    }

    .suggestion-item i {
        color: #667eea;
        margin-right: 8px;
    }

    .form-buttons {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }

    .search-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 16px 40px;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
        font-size: 1.05rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        flex: 1;
        min-width: 180px;
        min-height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.25);
    }

    .search-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    .search-btn:active {
        transform: translateY(-1px);
    }

    .reset-btn {
        background: white;
        color: #333;
        border: 2px solid #e0e0e0;
        padding: 16px 40px;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
        font-size: 1.05rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        min-height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .reset-btn:hover {
        background: #f5f5f5;
        border-color: #d0d0d0;
        transform: translateY(-2px);
    }

    .reset-btn:active {
        transform: translateY(0);
    }

    .reset-btn:hover {
        background: #d0d0d0;
    }

    .current-location-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 14px 40px;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .current-location-btn:hover {
        background: #218838;
        transform: translateY(-3px);
    }

    .current-location-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    /* Loading State */
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 20px;
    }

    .loading-spinner.active {
        display: block;
    }

    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Results Section */
    .results-section {
        margin-top: 40px;
    }

    .results-header {
        background: white;
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }

    .results-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .results-icon {
        font-size: 1.5rem;
        color: #667eea;
    }

    .results-title {
        font-size: 1.2rem;
        font-weight: 700;
        color: #333;
    }

    .results-count {
        font-size: 0.95rem;
        color: #666;
    }

    .sort-group {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .sort-group label {
        font-weight: 600;
        color: #333;
    }

    .sort-group select {
        padding: 8px 15px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 0.9rem;
    }

    .restaurants-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 25px;
    }

    .restaurant-card {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
    }

    .restaurant-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 15px 40px rgba(102, 126, 234, 0.2);
    }

    .restaurant-image {
        width: 100%;
        height: 200px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 3rem;
        position: relative;
        overflow: hidden;
    }

    .restaurant-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .distance-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #fe424d;
        color: white;
        padding: 8px 15px;
        border-radius: 25px;
        font-weight: 700;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 5px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .rating-badge {
        position: absolute;
        top: 10px;
        left: 10px;
        background: #ffc107;
        color: #333;
        padding: 8px 12px;
        border-radius: 8px;
        font-weight: 700;
        font-size: 0.9rem;
    }

    .restaurant-body {
        padding: 20px;
    }

    .restaurant-name {
        font-size: 1.2rem;
        font-weight: 700;
        color: #333;
        margin-bottom: 8px;
    }

    .restaurant-info {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 15px;
        font-size: 0.9rem;
        color: #666;
    }

    .info-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .info-item i {
        color: #667eea;
        width: 16px;
    }

    .restaurant-footer {
        display: flex;
        gap: 10px;
    }

    .card-btn {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
    }

    .btn-view {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-view:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(102, 126, 234, 0.4);
    }

    .btn-favorite {
        background: #f0f0f0;
        color: #666;
        border: 2px solid #ddd;
    }

    .btn-favorite:hover {
        background: #ffe0e0;
        border-color: #fe424d;
        color: #fe424d;
    }

    .no-results {
        background: white;
        text-align: center;
        padding: 60px 20px;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
    }

    .no-results i {
        font-size: 4rem;
        color: #ddd;
        margin-bottom: 20px;
        display: block;
    }

    .no-results h2 {
        font-size: 1.8rem;
        color: #333;
        margin-bottom: 10px;
    }

    .no-results p {
        color: #666;
        margin-bottom: 20px;
    }

    /* Map Section */
    .map-container {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-top: 40px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        min-height: 400px;
    }

    .map-placeholder {
        width: 100%;
        height: 400px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #999;
        font-size: 1.1rem;
    }

    /* Status Messages */
    .status-message {
        padding: 15px 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
    }

    .status-success {
        background: #d4edda;
        color: #155724;
        border: 2px solid #28a745;
    }

    .status-error {
        background: #f8d7da;
        color: #721c24;
        border: 2px solid #fe424d;
    }

    .status-info {
        background: #d1ecf1;
        color: #0c5460;
        border: 2px solid #667eea;
    }

    @media (max-width: 768px) {
        .finder-header h1 {
            font-size: 1.8rem;
        }

        .search-form {
            grid-template-columns: 1fr;
        }

        .form-buttons {
            flex-direction: column;
        }

        .restaurants-grid {
            grid-template-columns: 1fr;
        }

        .results-header {
            flex-direction: column;
            gap: 15px;
            align-items: flex-start;
        }

        .sort-group {
            width: 100%;
        }

        .sort-group select {
            width: 100%;
        }
    }
</style>

<div class="location-search-page">
    <div class="search-container">
        <!-- Location Finder Section -->
        <div class="location-finder">
            <div class="finder-header">
                <h1><i class="fas fa-map-location-dot"></i> Find Restaurants Near You</h1>
                <p>Discover amazing dining options based on your location</p>
            </div>

            <div class="location-methods">
                <div class="method-card">
                    <i class="fas fa-crosshairs"></i>
                    <h3>Current Location</h3>
                    <p>Use your device's GPS to find restaurants nearby</p>
                    <button class="method-btn" onclick="getCurrentLocation()">Use GPS</button>
                </div>

                <div class="method-card">
                    <i class="fas fa-city"></i>
                    <h3>Choose City</h3>
                    <p>Browse restaurants in any city you prefer</p>
                    <button class="method-btn" onclick="scrollToSearch()">Browse Cities</button>
                </div>

                <div class="method-card">
                    <i class="fas fa-search"></i>
                    <h3>Manual Search</h3>
                    <p>Search by area or neighborhood name</p>
                    <button class="method-btn" onclick="scrollToSearch()">Start Searching</button>
                </div>
            </div>
        </div>

        <!-- Search Form Section -->
        <div class="search-form-section">
            <h2 class="form-title">
                <i class="fas fa-filter"></i> Search & Filter Restaurants
            </h2>

            <div class="status-message" id="statusMessage" style="display: none;"></div>

            <form class="search-form" id="searchForm">
                <div class="form-group">
                    <label for="locationInput">Location / City</label>
                    <div class="location-input">
                        <input 
                            type="text" 
                            id="locationInput" 
                            placeholder="Enter city or area..." 
                            autocomplete="off"
                            onkeyup="handleLocationSearch()"
                        >
                        <div class="location-suggestions" id="locationSuggestions"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="cuisineFilter">Cuisine Type</label>
                    <select id="cuisineFilter">
                        <option value="">All Cuisines</option>
                        <option value="Indian">Indian</option>
                        <option value="Italian">Italian</option>
                        <option value="Chinese">Chinese</option>
                        <option value="Japanese">Japanese</option>
                        <option value="American">American</option>
                        <option value="Mexican">Mexican</option>
                        <option value="Thai">Thai</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="radiusFilter">Search Radius (km)</label>
                    <select id="radiusFilter">
                        <option value="5">5 km</option>
                        <option value="10" selected>10 km</option>
                        <option value="15">15 km</option>
                        <option value="25">25 km</option>
                        <option value="50">50 km</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="ratingFilter">Minimum Rating</label>
                    <select id="ratingFilter">
                        <option value="">All Ratings</option>
                        <option value="3">3+ Stars</option>
                        <option value="3.5">3.5+ Stars</option>
                        <option value="4">4+ Stars</option>
                        <option value="4.5">4.5+ Stars</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="priceFilter">Price Range</label>
                    <select id="priceFilter">
                        <option value="">All Prices</option>
                        <option value="200">Budget (â‚¹ 200-400)</option>
                        <option value="400">Moderate (â‚¹ 400-800)</option>
                        <option value="800">Premium (â‚¹ 800-1500)</option>
                        <option value="1500">Luxury (â‚¹ 1500+)</option>
                    </select>
                </div>
            </form>

            <div class="form-buttons">
                <button class="search-btn" onclick="searchByLocation()">
                    <i class="fas fa-search"></i> Search Restaurants
                </button>
                <button class="current-location-btn" onclick="getCurrentLocation()" id="gpsBtn">
                    <i class="fas fa-location-arrow"></i> Current Location
                </button>
                <button class="reset-btn" onclick="resetSearch()">
                    <i class="fas fa-redo"></i> Reset
                </button>
            </div>

            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner"></div>
                <p>Finding restaurants near you...</p>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection" style="display: none;">
            <div class="results-header">
                <div class="results-info">
                    <span class="results-icon"><i class="fas fa-map-pin"></i></span>
                    <div>
                        <div class="results-title" id="resultsTitle">Restaurants Found</div>
                        <div class="results-count" id="resultsCount"></div>
                    </div>
                </div>
                <div class="sort-group">
                    <label for="sortBy">Sort by:</label>
                    <select id="sortBy" onchange="resortResults()">
                        <option value="distance">Distance (Nearest First)</option>
                        <option value="rating">Rating (Highest First)</option>
                        <option value="name">Name (A-Z)</option>
                    </select>
                </div>
            </div>

            <div class="restaurants-grid" id="restaurantsGrid"></div>
        </div>

        <!-- Map Section -->
        <div class="map-container" id="mapContainer" style="display: none;">
            <div id="map" style="width:100%;height:420px;border-radius:10px;"></div>
        </div>
    </div>
</div>

<script>
    // Sample restaurant database with locations (latitude, longitude)
    const restaurantsDatabase = [
        { id: 1, name: "Taj Indian Kitchen", cuisine: "Indian", city: "New Delhi", rating: 4.8, price: 800, emoji: "ðŸ›", lat: 28.6139, lng: 77.2090 },
        { id: 2, name: "Pasta Paradise", cuisine: "Italian", city: "Mumbai", rating: 4.6, price: 800, emoji: "ðŸ", lat: 19.0760, lng: 72.8777 },
        { id: 3, name: "Dragon's Wok", cuisine: "Chinese", city: "Bangalore", rating: 4.5, price: 400, emoji: "ðŸ¥¢", lat: 12.9716, lng: 77.5946 },
        { id: 4, name: "Sushi Haven", cuisine: "Japanese", city: "Hyderabad", rating: 4.7, price: 1500, emoji: "ðŸ£", lat: 17.3850, lng: 78.4867 },
        { id: 5, name: "Burger Bliss", cuisine: "American", city: "Pune", rating: 4.4, price: 400, emoji: "ðŸ”", lat: 18.5204, lng: 73.8567 },
        { id: 6, name: "Spice Route", cuisine: "Indian", city: "Kolkata", rating: 4.9, price: 400, emoji: "ðŸŒ¶ï¸", lat: 22.5726, lng: 88.3639 },
        { id: 7, name: "Thai Street", cuisine: "Thai", city: "New Delhi", rating: 4.3, price: 400, emoji: "ðŸ¥˜", lat: 28.7041, lng: 77.1025 },
        { id: 8, name: "Pizza Palace", cuisine: "Italian", city: "Bangalore", rating: 4.5, price: 400, emoji: "ðŸ•", lat: 12.9520, lng: 77.6245 },
        { id: 9, name: "El Mariachi", cuisine: "Mexican", city: "Mumbai", rating: 4.2, price: 400, emoji: "ðŸŒ®", lat: 19.0825, lng: 72.8830 },
        { id: 10, name: "Beijing Express", cuisine: "Chinese", city: "New Delhi", rating: 4.6, price: 400, emoji: "ðŸ¥¡", lat: 28.6162, lng: 77.2310 },
        { id: 11, name: "Sakura Dreams", cuisine: "Japanese", city: "Bangalore", rating: 4.8, price: 800, emoji: "ðŸ±", lat: 12.9352, lng: 77.6245 },
        { id: 12, name: "Curry House", cuisine: "Indian", city: "Mumbai", rating: 4.7, price: 400, emoji: "ðŸ›", lat: 19.1136, lng: 72.8697 },
    ];

    const cities = {
        "New Delhi": { lat: 28.6139, lng: 77.2090 },
        "Mumbai": { lat: 19.0760, lng: 72.8777 },
        "Bangalore": { lat: 12.9716, lng: 77.5946 },
        "Hyderabad": { lat: 17.3850, lng: 78.4867 },
        "Pune": { lat: 18.5204, lng: 73.8567 },
        "Kolkata": { lat: 22.5726, lng: 88.3639 },
    };

    let currentLocation = null;
    let searchResults = [];

    // Show status message
    function showStatus(message, type) {
        const statusEl = document.getElementById('statusMessage');
        statusEl.textContent = message;
        statusEl.className = `status-message status-${type}`;
        statusEl.style.display = 'flex';
    }

    // Get current location
    function getCurrentLocation() {
        const gpsBtn = document.getElementById('gpsBtn');
        gpsBtn.disabled = true;
        document.getElementById('loadingSpinner').classList.add('active');

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    currentLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    // Try to reverse-geocode to get a human-friendly city name
                    reverseGeocode(currentLocation.lat, currentLocation.lng)
                        .then(city => {
                                            if (city) {
                                                document.getElementById('locationInput').value = city;
                                                try { localStorage.setItem('currentCity', city); } catch(e){}
                                                // If navbar update helper exists on page, call it so badge updates immediately
                                                if (window.updateNavCityDisplay) window.updateNavCityDisplay();
                                                showStatus(`ðŸ“ Location found: ${city} (Lat: ${currentLocation.lat.toFixed(4)}, Lon: ${currentLocation.lng.toFixed(4)})`, 'success');
                                            } else {
                                                try { localStorage.setItem('currentCity', ''); } catch(e){}
                                                if (window.updateNavCityDisplay) window.updateNavCityDisplay();
                                                showStatus(`ðŸ“ Location found (Lat: ${currentLocation.lat.toFixed(4)}, Lon: ${currentLocation.lng.toFixed(4)})`, 'success');
                                            }
                            searchByLocation();
                        })
                        .catch(err => {
                            console.error('Reverse geocode failed', err);
                            try { localStorage.setItem('currentCity', ''); } catch(e){}
                            showStatus(`ðŸ“ Location found (Lat: ${currentLocation.lat.toFixed(4)}, Lon: ${currentLocation.lng.toFixed(4)})`, 'success');
                            searchByLocation();
                        });
                    gpsBtn.disabled = false;
                    document.getElementById('loadingSpinner').classList.remove('active');
                },
                function(error) {
                    showStatus(`âŒ Unable to get location. Error: ${error.message}`, 'error');
                    gpsBtn.disabled = false;
                    document.getElementById('loadingSpinner').classList.remove('active');
                }
            );
        } else {
            showStatus('âŒ Geolocation is not supported by your browser', 'error');
            gpsBtn.disabled = false;
            document.getElementById('loadingSpinner').classList.remove('active');
        }
    }

    // Reverse geocode coordinates to a city name using OpenStreetMap Nominatim
    async function reverseGeocode(lat, lng) {
        try {
            const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lng)}&zoom=10&addressdetails=1`;
            const res = await fetch(url, { headers: { 'Accept-Language': 'en' } });
            if (!res.ok) throw new Error('Geocoding service error');
            const data = await res.json();
            if (data && data.address) {
                // Prefer city/town/village, then county/state
                return data.address.city || data.address.town || data.address.village || data.address.county || data.address.state || null;
            }
            return null;
        } catch (err) {
            console.error('reverseGeocode error', err);
            return null;
        }
    }

    // Handle location search suggestions
    function handleLocationSearch() {
        const input = document.getElementById('locationInput').value.toLowerCase();
        const suggestionsEl = document.getElementById('locationSuggestions');

        if (input.length === 0) {
            suggestionsEl.classList.remove('active');
            return;
        }

        const filtered = Object.keys(cities).filter(city => 
            city.toLowerCase().includes(input)
        );

        if (filtered.length === 0) {
            suggestionsEl.classList.remove('active');
            return;
        }

        suggestionsEl.innerHTML = filtered.map(city => `
            <div class="suggestion-item" onclick="selectLocation('${city}')">
                <i class="fas fa-map-pin"></i> ${city}
            </div>
        `).join('');
        suggestionsEl.classList.add('active');
    }

    // Select location from suggestions
    function selectLocation(city) {
        document.getElementById('locationInput').value = city;
        document.getElementById('locationSuggestions').classList.remove('active');
    }

    // Scroll to search section
    function scrollToSearch() {
        document.querySelector('.search-form-section').scrollIntoView({ behavior: 'smooth' });
    }

    // Calculate distance between two coordinates
    function calculateDistance(lat1, lng1, lat2, lng2) {
        const R = 6371; // Earth's radius in km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLng / 2) * Math.sin(dLng / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    // Search by location
    function searchByLocation() {
        document.getElementById('loadingSpinner').classList.add('active');
        
        const location = document.getElementById('locationInput').value;
        const cuisine = document.getElementById('cuisineFilter').value;
        const radius = parseInt(document.getElementById('radiusFilter').value);
        const rating = parseFloat(document.getElementById('ratingFilter').value) || 0;
        const price = parseInt(document.getElementById('priceFilter').value) || 0;

        let searchLat, searchLng;

        if (currentLocation) {
            searchLat = currentLocation.lat;
            searchLng = currentLocation.lng;
            // currentLocation may have originated from navbar GPS flow; attempt to set readable city if present
            // reverseGeocode already sets localStorage when available
        } else if (location && cities[location]) {
            searchLat = cities[location].lat;
            searchLng = cities[location].lng;
            try { localStorage.setItem('currentCity', location); if (window.updateNavCityDisplay) window.updateNavCityDisplay(); } catch(e){}
        } else if (location) {
            showStatus('âŒ Please select a valid city from suggestions', 'error');
            document.getElementById('loadingSpinner').classList.remove('active');
            return;
        } else {
            showStatus('âŒ Please enter a location or enable GPS', 'error');
            document.getElementById('loadingSpinner').classList.remove('active');
            return;
        }

        searchResults = restaurantsDatabase.filter(r => {
            const distance = calculateDistance(searchLat, searchLng, r.lat, r.lng);
            const matchCuisine = cuisine === '' || r.cuisine === cuisine;
            const matchRating = rating === 0 || r.rating >= rating;
            const matchPrice = price === 0 || r.price === price;
            const matchRadius = distance <= radius;

            if (matchCuisine && matchRating && matchPrice && matchRadius) {
                r.distance = distance;
                return true;
            }
            return false;
        });

        displayResults();
        document.getElementById('loadingSpinner').classList.remove('active');
    }

    // On page load, parse URL params to support /location-search?lat=..&lng=.. or ?city=Name
    (function handleInitialParams() {
        const params = new URLSearchParams(window.location.search);
        const lat = params.get('lat');
        const lng = params.get('lng');
        const city = params.get('city');

        if (lat && lng) {
            currentLocation = { lat: parseFloat(lat), lng: parseFloat(lng) };
            // Try to resolve city name for readability
            reverseGeocode(currentLocation.lat, currentLocation.lng).then(c => {
                if (c) document.getElementById('locationInput').value = c;
                searchByLocation();
            }).catch(() => searchByLocation());
        } else if (city) {
            document.getElementById('locationInput').value = city;
            searchByLocation();
        }
    })();

    // Display results
    function displayResults() {
        const resultsSection = document.getElementById('resultsSection');
        const restaurantsGrid = document.getElementById('restaurantsGrid');
        const resultsTitle = document.getElementById('resultsTitle');
        const resultsCount = document.getElementById('resultsCount');

        if (searchResults.length === 0) {
            restaurantsGrid.innerHTML = `
                <div class="no-results" style="grid-column: 1/-1;">
                    <i class="fas fa-search"></i>
                    <h2>No Restaurants Found</h2>
                    <p>Try adjusting your search criteria or expanding the search radius</p>
                </div>
            `;
            resultsTitle.textContent = 'No Results';
            resultsCount.textContent = '';
        } else {
            restaurantsGrid.innerHTML = searchResults.map(r => `
                <div class="restaurant-card">
                    <div class="restaurant-image">
                        ${r.emoji}
                        <div class="rating-badge">
                            <i class="fas fa-star"></i> ${r.rating}
                        </div>
                        <div class="distance-badge">
                            <i class="fas fa-location-arrow"></i> ${r.distance.toFixed(1)} km
                        </div>
                    </div>
                    <div class="restaurant-body">
                        <div class="restaurant-name">${r.name}</div>
                        <div class="restaurant-info">
                            <div class="info-item">
                                <i class="fas fa-utensils"></i> ${r.cuisine}
                            </div>
                            <div class="info-item">
                                <i class="fas fa-map-pin"></i> ${r.city}
                            </div>
                            <div class="info-item">
                                <i class="fas fa-rupee-sign"></i> ${'â‚¹'.repeat(r.price)}
                            </div>
                        </div>
                        <div class="restaurant-footer">
                            <button class="card-btn btn-view" onclick="window.location.href='/restaurant-details/${r.id}'">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="card-btn btn-favorite" onclick="addToFavorites('${r.name}')">
                                <i class="far fa-heart"></i> Save
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            resultsTitle.textContent = `${searchResults.length} Restaurant${searchResults.length !== 1 ? 's' : ''} Found`;
            resultsCount.textContent = `${searchResults.length} results near ${document.getElementById('locationInput').value || 'your location'}`;
        }

        resultsSection.style.display = 'block';
        resultsSection.scrollIntoView({ behavior: 'smooth' });

        // Initialize map with results
        try {
            initializeMap(searchResults, currentLocation);
            document.getElementById('mapContainer').style.display = 'block';
        } catch (err) {
            console.error('Map initialization failed', err);
        }
    }

    // Resort results
    function resortResults() {
        const sortBy = document.getElementById('sortBy').value;

        if (sortBy === 'distance') {
            searchResults.sort((a, b) => a.distance - b.distance);
        } else if (sortBy === 'rating') {
            searchResults.sort((a, b) => b.rating - a.rating);
        } else if (sortBy === 'name') {
            searchResults.sort((a, b) => a.name.localeCompare(b.name));
        }

        displayResults();
    }

    // Reset search
    function resetSearch() {
        document.getElementById('searchForm').reset();
        document.getElementById('locationInput').value = '';
        document.getElementById('cuisineFilter').value = '';
        document.getElementById('radiusFilter').value = '10';
        document.getElementById('ratingFilter').value = '';
        document.getElementById('priceFilter').value = '';
        document.getElementById('resultsSection').style.display = 'none';
        document.getElementById('statusMessage').style.display = 'none';
        document.getElementById('locationSuggestions').classList.remove('active');
        currentLocation = null;
        searchResults = [];
    }

    // Add to favorites
    function addToFavorites(name) {
        let favorites = JSON.parse(localStorage.getItem('restaurantFavorites')) || [];
        if (!favorites.includes(name)) {
            favorites.push(name);
            localStorage.setItem('restaurantFavorites', JSON.stringify(favorites));
            alert(`${name} added to favorites! â¤ï¸`);
        } else {
            alert(`${name} is already in your favorites!`);
        }
    }

    // Leaflet map initialization and marker rendering
    let leafletMap = null;
    let markersLayer = null;

    function initializeMap(rests, userLoc) {
        // Lazy load Leaflet if not already present
        if (typeof L === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
            script.onload = () => initializeMap(rests, userLoc);
            document.body.appendChild(script);
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
            document.head.appendChild(link);
            return;
        }

        const mapEl = document.getElementById('map');
        if (!mapEl) return;

        if (!leafletMap) {
            leafletMap = L.map('map');
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(leafletMap);
            markersLayer = L.layerGroup().addTo(leafletMap);
        }

        markersLayer.clearLayers();

        const bounds = [];
        // Add restaurant markers
        rests.forEach(r => {
            if (typeof r.lat === 'number' && typeof r.lng === 'number') {
                const marker = L.marker([r.lat, r.lng]);
                const distText = r.distance ? `${r.distance.toFixed(1)} km` : 'â€”';
                marker.bindPopup(`<strong>${escapeHtml(r.name || r.name)}</strong><br>${escapeHtml(r.city || '')}<br>Distance: ${distText}`);
                markersLayer.addLayer(marker);
                bounds.push([r.lat, r.lng]);
            }
        });

        // Add user marker
        if (userLoc && typeof userLoc.lat === 'number' && typeof userLoc.lng === 'number') {
            const um = L.circleMarker([userLoc.lat, userLoc.lng], { radius: 8, color: '#ff5722', fillColor: '#ff8a65', fillOpacity: 1 }).bindPopup('You are here');
            markersLayer.addLayer(um);
            bounds.push([userLoc.lat, userLoc.lng]);
        }

        if (bounds.length > 0) {
            leafletMap.fitBounds(bounds, { padding: [40, 40], maxZoom: 14 });
        }
    }

    // Prevent page refresh on Enter
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('searchForm').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchByLocation();
            }
        });
    });
</script>
